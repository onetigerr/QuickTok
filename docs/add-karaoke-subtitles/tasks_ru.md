# Задачи: Добавление караоке-субтитров

## 1. Фундамент и инфраструктура

- [ ] 1.1 Создать структуру модуля `src/subtitles/` с `__init__.py`
- [ ] 1.2 Создать `models.py` с Pydantic-моделями (`WordBoundary`, `SubtitleEvent`, `TTSResult`, `KaraokeResult`, `KaraokeConfig`)
- [ ] 1.3 Создать `storage.py` с `StorageManager` (хэширование контента, управление директориями)
- [ ] 1.4 Добавить `data/audio/` в `.gitignore` и создать placeholder
- [ ] 1.5 Добавить зависимости в `pyproject.toml`: `edge-tts>=6.1.0`

## 2. Обработка текста

- [ ] 2.1 Создать `normalizer.py` с классом `TextNormalizer`
- [ ] 2.2 Реализовать правила нормализации (пробелы, кавычки, тире, контрольные символы)
- [ ] 2.3 Реализовать токенизацию (слова vs пунктуация)
- [ ] 2.4 Написать юнит-тесты для `TextNormalizer` (`tests/subtitles/test_normalizer.py`)

## 3. TTS-движок

- [ ] 3.1 Создать `tts_engine.py` с классом `TTSEngine`
- [ ] 3.2 Реализовать синтез Edge TTS с захватом событий word-boundary
- [ ] 3.3 Реализовать интерполяцию таймингов для отсутствующих слов
- [ ] 3.4 Добавить конфигурацию для выбора языка и голоса
- [ ] 3.5 Написать юнит-тесты для `TTSEngine` (мокаем edge-tts, тестируем парсинг границ)

## 4. Генерация субтитров

- [ ] 4.1 Создать `segmenter.py` с классом `SubtitleSegmenter`
- [ ] 4.2 Реализовать алгоритм однострочной сегментации
- [ ] 4.3 Создать `ass_generator.py` с классом `ASSGenerator`
- [ ] 4.4 Реализовать генерацию ASS-заголовка с настраиваемыми стилями
- [ ] 4.5 Реализовать форматирование караоке-тегов (`\kf` с длительностью в сотых секунды)
- [ ] 4.6 Обработать пунктуацию (нулевая длительность, без подсветки)
- [ ] 4.7 Написать юнит-тесты для сегментатора и ASS-генератора

## 5. Рендеринг видео

- [ ] 5.1 Создать `renderer.py` с классом `KaraokeRenderer`
- [ ] 5.2 Реализовать зондирование видео (длительность, размеры через ffprobe)
- [ ] 5.3 Реализовать кроп до aspect ratio 9:16 (центральный кроп)
- [ ] 5.4 Реализовать зацикливание/обрезку видео под длительность аудио
- [ ] 5.5 Реализовать прожиг субтитров через FFmpeg-фильтр `subtitles`
- [ ] 5.6 Реализовать микширование аудио с видео
- [ ] 5.7 Написать интеграционные тесты для караоке-рендерера (тест на малых фикстурах)

## 6. Пайплайн и CLI

- [ ] 6.1 Создать `pipeline.py` с классом `KaraokePipeline`
- [ ] 6.2 Реализовать полную оркестрацию (нормализация → TTS → сегментация → ASS → сборка)
- [ ] 6.3 Реализовать кэширование артефактов (пропуск TTS, если хэш существует)
- [ ] 6.4 Реализовать логирование ключевых метрик (длительность, кол-во слов, сегментов, % интерполяции)
- [ ] 6.5 Создать `__main__.py` с CLI на Typer
- [ ] 6.6 Реализовать команду `create` со всеми опциями
- [ ] 6.7 Написать end-to-end тест для CLI

## 7. Конфигурация и стили

- [ ] 7.1 Создать `styles.py` с дефолтной конфигурацией `SubtitleStyle`
- [ ] 7.2 Реализовать загрузку JSON-конфигурации для кастомных стилей
- [ ] 7.3 Создать пример конфигурации стилей в `examples/subtitle_style.json`
- [ ] 7.4 Задокументировать доступные опции стилей

## 8. Документация

- [ ] 8.1 Создать `README.md` для модуля subtitles с примерами использования
- [ ] 8.2 Добавить docstrings ко всем публичным функциям и классам
- [ ] 8.3 Обновить основной README.md проекта ссылкой на новый модуль

## 9. Верификация

- [ ] 9.1 Запустить все юнит-тесты: `pytest tests/subtitles/ -v`
- [ ] 9.2 Тест с испанским скриптом: проверить синхронизацию подсветки с аудио
- [ ] 9.3 Тест с фоном другого aspect ratio: проверить корректность кропа
- [ ] 9.4 Тест с коротким фоновым видео: проверить работу зацикливания
- [ ] 9.5 Тест с длинным фоновым видео: проверить работу обрезки
- [ ] 9.6 Визуальная проверка финального видео
- [ ] 9.7 Тест CLI с различными комбинациями опций

---

## Зависимости

| Задача | Зависит от |
|--------|------------|
| 2.x Обработка текста | 1.x Фундамент |
| 3.x TTS-движок | 1.x Фундамент, 2.x Обработка текста |
| 4.x Генерация субтитров | 3.x TTS-движок |
| 5.x Сборка видео | 4.x Генерация субтитров |
| 6.x Пайплайн | Всё вышеперечисленное |
| 7.x Конфигурация | 1.x Фундамент |
| 8.x Документация | 6.x Пайплайн (можно параллельно) |
| 9.x Верификация | 6.x Пайплайн |

## Параллельная работа

- Задачи 2.x и 7.x могут выполняться параллельно после 1.x
- Задачи 4.3-4.6 (ASS) могут идти параллельно с 4.1-4.2 (Сегментатор) после 3.x
- Задачи 8.x могут продвигаться параллельно с поздними задачами реализации

---

## Будущий скоуп (не реализуется)

> [!NOTE]
> Эти пункты задокументированы для справки, но НЕ входят в это изменение.

- **Пакетный режим**: `python -m src.subtitles batch --input-dir scripts/ --bg bg.mp4 --output-dir output/`
- **Пресеты стилей**: Встроенные стили типа `neon`, `minimal`, `bold`
- **Микширование музыки**: Опциональный флаг `--music` для фоновой дорожки
- **Режим превью**: Быстрый просмотр без полного кодирования видео
