# Изменение: Добавление модуля караоке-субтитров

## Зачем

QuickTok должен генерировать TikTok-ready видео с синхронизированной озвучкой (TTS) и караоке-субтитрами (прогрессивная подсветка слов). Эта функция критически важна для создания вовлекающего короткого контента с визуальным текстом, который подсвечивается слово за словом по мере озвучки — это значительно повышает удержание зрителя и доступность контента.

На данный момент создание видео и генерация аудио концептуально разделены в роудмапе. Это изменение вводит отдельный независимый модуль, который обрабатывает полный пайплайн: нормализация текста → синтез TTS с таймингами слов → генерация ASS-субтитров с караоке-эффектами → финальная сборка видео с прожжёнными субтитрами.

## Что меняется

### Новый модуль: `src/subtitles/`

Автономный модуль для генерации видео с TTS-аудио и караоке-субтитрами:

- **Нормализатор текста**: Очищает и подготавливает входной текст для TTS (пробелы, кавычки, тире, правила для чисел/аббревиатур).
- **TTS-движок**: Синтезирует речь через Edge TTS с захватом событий word-boundary (`audioOffset`, `duration`).
- **Генератор субтитров**: Создаёт ASS-файлы с караоке-тегами (`\K`, `\kf`) для прогрессивной заливки слов.
- **Видеорендерер**: Собирает финальное видео, комбинируя фоновое видео, TTS-аудио и прожжённые субтитры через FFmpeg.
- **Конфигурация стилей**: Настраиваемый внешний вид субтитров (шрифт, цвет, размер, позиция, цвет подсветки) с разумными значениями по умолчанию.

### Новая структура данных: `data/audio/`

Организованное хранилище TTS-артефактов:
```
data/audio/
└── {content_hash}/           # Хэш входного текста для уникальности
    ├── voice.mp3             # Синтезированное аудио
    ├── word_boundaries.json  # Данные таймингов слов
    ├── subs.ass              # Сгенерированные ASS-субтитры
    └── metadata.json         # Параметры генерации
```

### CLI-интерфейс

```bash
python -m src.subtitles --script script_es.txt --bg bg.mp4 --output final.mp4
python -m src.subtitles --script script_es.txt --bg bg.mp4 --lang es-ES --voice ElviraNeural
python -m src.subtitles --script script_es.txt --bg bg.mp4 --style-config styles.json
```

### Ключевые функции

1. **Однострочное отображение**: Текст сегментируется для показа одной строки за раз (без переноса на две строки).
2. **Караоке-подсветка**: Слова прогрессивно заливаются цветом на основе TTS-таймингов.
3. **Обработка пунктуации**: Знаки препинания отображаются, но не подсвечиваются.
4. **Политика длительности видео**: Длительность аудио — источник истины; фоновое видео зацикливается или обрезается.
5. **Приведение aspect ratio**: Фоновое видео кропается (не ресайзится) до 9:16 при необходимости.
6. **Мультиязычность**: Настраиваемый выбор языка и голоса Edge TTS.
7. **Интерполяция таймингов**: Резервная интерполяция для слов без данных о времени.

## Влияние

- **Затронутые спеки**: Нет (новая функциональность)
- **Новые спеки**: `subtitles`
- **Затронутый код**: Нет (новый модуль)
- **Новые директории**: `src/subtitles/`, `data/audio/`
- **Зависимости**: `edge-tts`, `ffmpeg-python` (уже запланирован), `hashlib` (stdlib)

## Будущие расширения (вне скоупа)

- Пакетный режим для нескольких скриптов (задокументировано, но не реализуется сейчас)
- Интеграция с LLM для генерации скриптов
- Микширование фоновой музыки
- Автогенерация фонов из изображений
